{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
    /* Chat konteyner */
    .chat-container { 
        height: 85vh; 
        display: flex; 
        flex-direction: column; 
        background: #fff; 
        border-radius: 15px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
        overflow: hidden; 
    }
    
    /* Header - Binafsha rang (Universal AI ekanligini bildirish uchun) */
    .chat-header { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
        padding: 15px 25px; 
        display: flex; 
        align-items: center; 
        gap: 15px; 
    }
    
    .chat-box { flex: 1; padding: 25px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column; gap: 20px; }
    
    /* Xabarlar */
    .message { max-width: 85%; padding: 15px 20px; border-radius: 18px; font-size: 1rem; line-height: 1.6; position: relative; animation: fadeIn 0.3s ease; word-wrap: break-word; }
    
    /* User xabari - O'ng tomonda */
    .message.user { align-self: flex-end; background: #764ba2; color: white; border-bottom-right-radius: 4px; }
    
    /* AI xabari - Chap tomonda */
    .message.ai { align-self: flex-start; background: white; color: #212529; border-bottom-left-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
    
    /* Kod bloklari uchun stil */
    .message pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 10px; overflow-x: auto; margin-top: 10px; }
    .message code { font-family: 'Courier New', Courier, monospace; font-size: 0.9em; }

    /* Input maydoni */
    .chat-input-area { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 15px; }
    
    .typing-indicator { align-self: flex-start; background: white; padding: 10px 15px; border-radius: 15px; display: none; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .dot { height: 8px; width: 8px; background: #764ba2; border-radius: 50%; display: inline-block; animation: bounce 1.3s linear infinite; margin: 0 2px; }
    .dot:nth-child(2) { animation-delay: -1.1s; }
    .dot:nth-child(3) { animation-delay: -0.9s; }
    
    @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="container-fluid py-3 px-4"> 
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9"> 
            <div class="chat-container">
                
                <div class="chat-header">
                    <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 45px; height: 45px;">
                        <i class="fa-solid fa-wand-magic-sparkles fa-lg" style="color: #764ba2;"></i>
                    </div>
                    <div>
                        <h5 class="mb-0 fw-bold">Smart AI Assistant</h5>
                        <small class="opacity-75">
                            <i class="fa-solid fa-globe me-1"></i> Universal Bilim Bazasi
                        </small>
                    </div>
                </div>

                <div class="chat-box" id="chatBox">
                    <div class="message ai">
                        Assalomu alaykum, <b>{{ user.first_name }}</b>! ‚ú®<br>
                        Men sizning aqlli yordamchingizman. <br><br>
                        Mendan istalgan narsani so'rashingiz mumkin:<br>
                        üîπ Kod yozish va dasturlash<br>
                        üîπ Tarjima va matn yozish<br>
                        üîπ Ilmiy savollar va maslahatlar<br>
                        <br>
                        <i>Savolingizni yozing...</i>
                    </div>
                    
                    <div class="typing-indicator" id="typing">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="userInput" class="form-control border-0 bg-light py-3 px-4 rounded-pill shadow-sm" placeholder="Mavzu, kod yoki savol yozing..." autocomplete="off" style="font-size: 1.1rem;">
                    <button onclick="sendMessage()" class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center" style="width: 55px; height: 55px; background: #764ba2; border: none;">
                        <i class="fa-solid fa-paper-plane fa-lg"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const typing = document.getElementById('typing');

    // Marked.js sozlamalari (Enter bosilganda yangi qator emas, <br> tashlashi uchun)
    marked.setOptions({
        breaks: true,
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return hljs.highlightAuto(code).value;
        }
    });

    userInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") sendMessage();
    });

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.classList.add('message', sender);
        
        if (sender === 'ai') {
            // Markdown formatlash
            div.innerHTML = marked.parse(text);
        } else {
            div.textContent = text;
        }
        
        // Typing indicatoridan oldin qo'shish
        chatBox.insertBefore(div, typing);
        chatBox.scrollTop = chatBox.scrollHeight;
        
        // Agar kod bo'lsa, highlight qilish
        if (sender === 'ai') {
            div.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage(text, 'user');
        userInput.value = '';
        
        // Typing effektini yoqish
        typing.style.display = 'block';
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            // DIQQAT: Bu yerda Universal API chaqirilmoqda
            const response = await fetch('/smart-assistant/api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ message: text })
            });
            
            const data = await response.json();
            typing.style.display = 'none';
            
            if (data.status === 'success') {
                appendMessage(data.reply, 'ai');
            } else {
                appendMessage("‚ö†Ô∏è Xatolik: " + data.message, 'ai');
            }
        } catch (error) {
            typing.style.display = 'none';
            appendMessage("‚ùå Internet bilan aloqa yo'q.", 'ai');
        }
    }
</script>
{% endblock %}