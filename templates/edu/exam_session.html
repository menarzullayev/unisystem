{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="card mb-4 border-0 shadow-sm bg-primary text-white">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0 fw-bold">
                    {% if section.section_type == 'reading' %}
                        üìñ Reading
                    {% elif section.section_type == 'writing' %}
                        ‚úçÔ∏è Writing (Academic)
                    {% endif %}
                </h4>
                <small class="opacity-75">{{ section.title }}</small>
            </div>
            <div class="fs-4 fw-bold" id="timer">
                <i class="fa-regular fa-clock me-2"></i> <span id="timeRemaining">{{ section.duration }}:00</span>
            </div>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="examForm">
        {% csrf_token %}
        
        <div class="row g-4">
            {% if section.section_type == 'reading' %}
                <div class="col-lg-7">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0 text-primary">Reading Passage</h5>
                        </div>
                        <div class="card-body">
                            {% if displayed_content %}
                                <div class="bg-white p-4 rounded border shadow-sm" style="max-height: 700px; overflow-y: auto; line-height: 1.8; font-size: 1.15rem; text-align: justify;">
                                    {# linebreaks va displayed_content ishlatildi #}
                                    {{ displayed_content|linebreaks }}
                                </div>
                            {% else %}
                                <p class="text-muted">Matn yuklanmagan.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0 text-success">Questions</h5>
                        </div>
                        <div class="card-body">
                            <div class="questions-container pe-2" style="max-height: 700px; overflow-y: auto;">
                                {% for q in questions %}
                                <div class="mb-4 pb-3 border-bottom">
                                    <p class="fw-bold mb-3">
                                        <span class="badge bg-secondary me-2">{{ q.order }}</span>
                                        {{ q.question_text }}
                                    </p>
                                    
                                    {% if q.question_type == 'tfng' %}
                                        <div class="d-flex flex-column gap-2 ps-3">
                                            <label class="btn btn-outline-primary text-start border bg-white py-2 px-3 hover-shadow">
                                                <input type="radio" name="question_{{ q.id }}" value="TRUE" class="me-2"> TRUE
                                            </label>
                                            <label class="btn btn-outline-primary text-start border bg-white py-2 px-3 hover-shadow">
                                                <input type="radio" name="question_{{ q.id }}" value="FALSE" class="me-2"> FALSE
                                            </label>
                                            <label class="btn btn-outline-primary text-start border bg-white py-2 px-3 hover-shadow">
                                                <input type="radio" name="question_{{ q.id }}" value="NOT GIVEN" class="me-2"> NOT GIVEN
                                            </label>
                                        </div>
                                    {% elif q.question_type == 'gap_fill' %}
                                        <div class="ps-3">
                                            <input type="text" name="question_{{ q.id }}" class="form-control form-control-lg border-primary-subtle" placeholder="Your answer..." autocomplete="off">
                                        </div>
                                    {% endif %}
                                </div>
                                {% empty %}
                                    <div class="text-center py-5 text-muted">
                                        <i class="fa-solid fa-clipboard-question fa-3x mb-3 opacity-25"></i>
                                        <p>No questions found for this section.</p>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

            {% elif section.section_type == 'writing' %}
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header bg-warning py-3">
                            <h5 class="fw-bold mb-0 text-dark">WRITING TASK 1</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            {% if section.writing_task1_instruction %}
                                <div class="alert alert-dark border-0 small mb-3">
                                    <i class="fa-solid fa-circle-info me-2"></i>{{ section.writing_task1_instruction }}
                                </div>
                            {% endif %}
                            
                            <div class="bg-light p-3 rounded border mb-3" style="min-height: 120px; max-height: 250px; overflow-y: auto;">
                                <h6 class="fw-bold small text-primary">TOPIC:</h6>
                                {{ section.writing_task1_content|linebreaks }}
                            </div>

                            <textarea name="task1_text" id="task1_area" class="form-control flex-grow-1 p-3 border-warning-subtle" 
                                      style="min-height: 300px; resize: none;" placeholder="Write your Task 1 response here..." required></textarea>
                            <div class="mt-2 text-end text-muted small" id="wordCount1">0 words</div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header bg-info py-3">
                            <h5 class="fw-bold mb-0 text-white">WRITING TASK 2</h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            {% if section.writing_task2_instruction %}
                                <div class="alert alert-dark border-0 small mb-3">
                                    <i class="fa-solid fa-circle-info me-2"></i>{{ section.writing_task2_instruction }}
                                </div>
                            {% endif %}
                            
                            <div class="bg-light p-3 rounded border mb-3" style="min-height: 120px; max-height: 250px; overflow-y: auto;">
                                <h6 class="fw-bold small text-primary">TOPIC:</h6>
                                {{ section.writing_task2_content|linebreaks }}
                            </div>

                            <textarea name="task2_text" id="task2_area" class="form-control flex-grow-1 p-3 border-info-subtle" 
                                      style="min-height: 300px; resize: none;" placeholder="Write your Task 2 response here..." required></textarea>
                            <div class="mt-2 text-end text-muted small" id="wordCount2">0 words</div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="row mt-4">
            <div class="col-12 d-grid">
                <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm" id="submitBtn">
                    Finish and Submit Exam <i class="fa-solid fa-check-double ms-2"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    let duration = {{ section.duration }} * 60;
    const timerDisplay = document.getElementById('timeRemaining');
    const timerIcon = document.getElementById('timer');
    
    const timerInterval = setInterval(() => {
        let minutes = Math.floor(duration / 60);
        let seconds = duration % 60;
        seconds = seconds < 10 ? '0' + seconds : seconds;
        timerDisplay.textContent = `${minutes}:${seconds}`;
        
        if (duration < 60) {
            timerIcon.classList.remove('text-dark');
            timerIcon.classList.add('text-danger', 'blink');
        }

        if (--duration < 0) {
            clearInterval(timerInterval);
            alert("Time is up! Your answers will be submitted automatically.");
            document.getElementById('examForm').submit();
        }
    }, 1000);

    function setupWordCount(areaId, countId) {
        const area = document.getElementById(areaId);
        const display = document.getElementById(countId);
        if (area) {
            area.addEventListener('input', function() {
                const text = this.value.trim();
                const words = text ? text.split(/\s+/).length : 0;
                display.textContent = `${words} words`;
            });
        }
    }

    setupWordCount('task1_area', 'wordCount1');
    setupWordCount('task2_area', 'wordCount2');
</script>

<style>
    .hover-shadow:hover { box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1); transition: 0.2s; }
    .blink { animation: blinker 1s linear infinite; }
    @keyframes blinker { 50% { opacity: 0; } }
    .card-header { border-bottom: none; }
    textarea:focus { box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.15); border-color: #2563eb !important; }
    input[type="text"]:focus { box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.15); border-color: #2563eb !important; }
    .questions-container::-webkit-scrollbar { width: 6px; }
    .questions-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>
{% endblock %}