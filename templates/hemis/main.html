{% extends 'base.html' %}

{% block content %}
<style>
    #hemisTab .nav-link { color: #495057 !important; background-color: #f8f9fa; border: 1px solid #dee2e6; margin-right: 5px; border-radius: 8px; }
    #hemisTab .nav-link:hover { background-color: #e9ecef !important; color: #0d6efd !important; }
    #hemisTab .nav-link.active { color: #ffffff !important; background-color: #0d6efd !important; border-color: #0d6efd; }
    .schedule-card { transition: transform 0.2s; border-top: 4px solid #0d6efd; }
    .schedule-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
    .task-row { transition: background 0.2s; }
    .task-row:hover { background-color: #f8f9fa; }
</style>

<div class="container-fluid">
    
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body p-3 d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0 fw-bold text-primary"><i class="fa-solid fa-server me-2"></i>Hemis Ma'lumotlari</h4>
                <a href="{% url 'update_data' %}" class="btn btn-sm btn-outline-primary rounded-pill">
                    <i class="fa-solid fa-arrows-rotate me-1"></i> Yangilash
                </a>
            </div>
            
            <form method="get" class="d-flex align-items-center">
                <label class="me-2 fw-bold text-muted small text-uppercase">Semestr:</label>
                <select name="semester" class="form-select border-primary fw-bold" style="min-width: 150px;" onchange="this.form.submit()">
                    {% for sem in all_semesters %}
                        <option value="{{ sem.code }}" {% if sem.code == selected_sem_id %}selected{% endif %}>
                            {{ sem.name }} {% if sem.current %}(Joriy){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>

    <ul class="nav nav-pills mb-4" id="hemisTab" role="tablist">
        <li class="nav-item"><button class="nav-link active fw-bold px-4" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule">Dars Jadvali</button></li>
        <li class="nav-item"><button class="nav-link fw-bold px-4" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance">Davomat</button></li>
        <li class="nav-item"><button class="nav-link fw-bold px-4" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks">Topshiriqlar</button></li>
    </ul>

    <div class="tab-content" id="hemisTabContent">
        
        <div class="tab-pane show active" id="schedule" role="tabpanel">
            {% if all_weeks %}
            <div class="d-flex justify-content-end mb-3">
                <form method="get" class="d-flex align-items-center bg-white p-2 rounded shadow-sm border">
                    <input type="hidden" name="semester" value="{{ selected_sem_id }}">
                    <label class="me-2 fw-bold text-muted small text-uppercase"><i class="fa-regular fa-calendar-check me-1"></i>Hafta:</label>
                    <select name="week" class="form-select form-select-sm border-success fw-bold" style="min-width: 200px;" onchange="this.form.submit()">
                        {% for w in all_weeks %}
                            <option value="{{ w.week_id }}" {% if w.week_id == selected_week_id %}selected{% endif %}>
                                {{ w.name }} {% if w.current %}(Hozir){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            {% endif %}

            {% if schedule %}
            <div class="row g-4">
                {% for day_group in schedule %}
                <div class="col-xl-4 col-lg-6 col-md-12">
                    <div class="card h-100 shadow-sm border-0 schedule-card">
                        <div class="card-header bg-white py-3 border-bottom-0">
                            <h5 class="fw-bold text-primary mb-0 text-uppercase"><i class="fa-regular fa-calendar me-2"></i>{{ day_group.day_name }}</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="table-light"><tr><th style="width: 30%">Vaqt</th><th>Fan / O'qituvchi</th></tr></thead>
                                    <tbody>
                                        {% for lesson in day_group.lessons %}
                                        <tr>
                                            <td class="text-center border-end">
                                                <span class="badge bg-primary rounded-pill mb-1">{{ lesson.lesson_time }}</span><br>
                                                <small class="text-muted fw-bold">{{ lesson.room }}</small>
                                            </td>
                                            <td class="ps-3">
                                                <div class="fw-bold text-dark">{{ lesson.subject.name }}</div>
                                                <div class="small text-muted">{{ lesson.teacher }}</div>
                                                <span class="badge bg-light text-dark border mt-1">{{ lesson.training_type }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center p-5 shadow-sm rounded-3">
                <i class="fa-solid fa-calendar-xmark fa-3x mb-3"></i>
                <h4>Bu hafta uchun dars jadvali topilmadi.</h4>
                <p>Ma'lumotlarni yangilab ko'ring.</p>
            </div>
            {% endif %}
        </div>

        <div class="tab-pane" id="attendance" role="tabpanel">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card bg-danger bg-opacity-10 border-danger border-start border-4 shadow-sm">
                        <div class="card-body text-center p-2">
                            <small class="text-uppercase text-danger fw-bold">Jami Qoldirilgan</small>
                            <h3 class="mb-0 fw-bold text-danger">{{ attendance.total }} <small class="fs-6 text-muted">soat</small></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success bg-opacity-10 border-success border-start border-4 shadow-sm">
                        <div class="card-body text-center p-2">
                            <small class="text-uppercase text-success fw-bold">Sababli</small>
                            <h3 class="mb-0 fw-bold text-success">{{ attendance.sababli }} <small class="fs-6 text-muted">soat</small></h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning bg-opacity-10 border-warning border-start border-4 shadow-sm">
                        <div class="card-body text-center p-2">
                            <small class="text-uppercase text-warning fw-bold">Sababsiz</small>
                            <h3 class="mb-0 fw-bold text-warning">{{ attendance.sababsiz }} <small class="fs-6 text-muted">soat</small></h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-primary"><i class="fa-solid fa-clock-rotate-left me-2"></i>Davomat Tarixi</h5>
                </div>
                <div class="card-body p-0 table-responsive">
                    {% if attendance.list %}
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-muted text-uppercase small">
                            <tr>
                                <th class="ps-4">Fan</th>
                                <th>Mashg'ulot</th>
                                <th>O'qituvchi</th>
                                <th class="text-center">Sana & Vaqt</th>
                                <th class="text-center">Holat</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in attendance.list %}
                            <tr>
                                <td class="ps-4 fw-bold text-dark">{{ item.subject.name }}</td>
                                <td><span class="badge bg-light text-dark border">{{ item.training_type }}</span></td>
                                <td class="text-muted small">
                                    <i class="fa-solid fa-user-tie me-1"></i> {{ item.teacher }}
                                </td>
                                <td class="text-center">
                                    <div class="fw-bold">{{ item.date|date:"d.m.Y" }}</div>
                                    <small class="text-muted">{{ item.time_str }}</small>
                                </td>
                                <td class="text-center">
                                    {% if item.type == 'Sababsiz' %}
                                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger rounded-pill px-3">
                                            Sababsiz: {{ item.hours }} soat
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success bg-opacity-10 text-success border border-success rounded-pill px-3">
                                            Sababli: {{ item.hours }} soat
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                        <div class="text-center p-5">
                            <i class="fa-solid fa-clipboard-check fa-3x text-muted mb-3"></i>
                            <p class="text-muted fw-bold">Davomat topilmadi.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane" id="tasks" role="tabpanel">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-primary"><i class="fa-solid fa-list-check me-2"></i>Barcha Topshiriqlar</h5>
                    <span class="badge bg-primary rounded-pill">{{ tasks|length }} ta</span>
                </div>
                <div class="card-body p-0 table-responsive">
                    {% if tasks %}
                    <table class="table align-middle mb-0">
                        <thead class="bg-light text-secondary text-uppercase small">
                            <tr>
                                <th class="ps-4 py-3" style="width: 35%;">Fan Nomi</th>
                                <th>Topshiriq</th>
                                <th>Muddat</th>
                                <th style="width: 25%;">Baho / Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in tasks %}
                            <tr class="task-row border-bottom">
                                <td class="ps-4 py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary bg-opacity-10 text-primary rounded p-2 me-3">
                                            <i class="fa-solid fa-book"></i>
                                        </div>
                                        <span class="fw-bold text-dark">{{ t.subject.name }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-semibold text-secondary">{{ t.name }}</span>
                                </td>
                                <td>
                                    {% if t.deadline == 'Muddatsiz' %}
                                        <span class="badge bg-secondary bg-opacity-25 text-secondary border">
                                            <i class="fa-regular fa-calendar me-1"></i> Muddatsiz
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                                            <i class="fa-regular fa-clock me-1"></i> {{ t.deadline }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="pe-4">
                                    {% if t.grade_val > 0 %}
                                        <div class="d-flex align-items-center justify-content-between mb-1">
                                            <span class="fw-bold text-dark">{{ t.grade }}</span>
                                            <small class="text-muted">max: {{ t.max_ball }}</small>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar {% if t.percentage >= 80 %}bg-success{% elif t.percentage >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ t.percentage }}%;"></div>
                                        </div>
                                    {% else %}
                                        {% if t.status == 'Baholandi' %}
                                            <span class="badge bg-success w-100 py-2">Baholangan</span>
                                        {% elif t.status == 'Yuklandi' or t.status == 'Yuborildi' %}
                                            <span class="badge bg-info text-dark w-100 py-2">Tekshirilmoqda</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark border w-100 py-2">{{ t.status }}</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center p-5">
                        <i class="fa-solid fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <p class="text-muted fw-bold">Topshiriqlar yo'q.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}